<!DOCTYPE html>
<html>
 
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <meta name="description" content="Blockly for arduino">
  <meta name="keywords" content="Arduino, Blockly, Ereko, Modelos Educacionais">
  <meta name="author" content="Ana Caroline Braz">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/arduino-light.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>

  <title>ErekoBlockly</title>

  <!-- Import materialize.css  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

  <!--Let browser know website is optimized for mobile-->
  <title>Ereko Blockly</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  
  <!--blocklys-->
  
  <script src="blockly/blockly_compressed.js"></script>
  <script src="blockly/blocks_compressed.js"></script>
  <script src="blockly/javascript_compressed.js"></script>
  <script src="blockly/msg/js/en.js"></script> 
  <script src="blockly/blocos.js"></script>  
  <script src="blockly/generator.js"></script>
  <script src="blockly/workspace.js"></script>    
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
       AOS.init();
  </script>
</head>

<style>
    .clearfix {
        overflow: auto;
    }
</style>

<body>
  <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">EREKO BLOCKLY</a>
      <ul class="right hide-on-med-and-down">       
        <button id="Download" class="btn waves-effect waves-light" type="submit" name="action">Download do codigo (.ino)</button>
        <button id="connectArduino" class="btn waves-effect waves-light">Conectar ao Arduino</button>
        <button id="sendCode" class="btn waves-effect waves-light" disabled>Enviar Código</button>        
      </ul>
    </div>
  </nav>

    <div class="col s12" style="height: 600px">
        <div class="row">
            <div class="col s6" style="height: 600px">
              <div class="center", style="background-color: #2c7fd2">
                <h5>Área destinada aos blocos</h5>
                <!-- <h5>Area intended for blocks</h5> -->
              </div>
                <div id="blocklyDiv" style="float:left; height: 600px; width: 102%;border-style: solid; border-color: #2c7fd2; background-color: #598aba"></div>
            </div>
            <div class="col s6">
              <div class="center", style="background-color: #22f702">
                <h5>Área destinada a geração do código em C</h5>
                <!-- <h5>Area intended for generating code in C</h5> -->
              </div>
              <div id="codigogerado" style="font-family: 'Courier New', Courier, monospace; float:left; height: 600px; width: 100%;background-color: #FFFFFF;
              color: #000; border-style: solid; border-color: #22f702;" class="clearfix">
               <!-- <pre><code id="codigogerado" class="language-c"></code></pre> -->
              </div>
            </div>
        </div>
    </div>

    <xml id="toolbox" style="display: none">	 
        
      <category name="Biblioteca" colour="2eff00">
        <block type="Biblioteca_Motor"></block>
        <block type="SoftwareSerial"></block>         
      </category>

      <category name="Funções" colour="d6df1c">
          <block type="setup"></block>
          <block type="loop"></block>
      </category> 

      <category name="Erekopapa" colour="00ffaa"> <!-- Antropomórfico -->
      <!-- <category name="Anthropomorphic" colour="00ffaa"> Erekopapa      -->
          <category name="Olhos" >
              <block type="led"></block>              
              <block type="pinmode_led"></block>              
              <block type="digitalwrite_led"></block>
          </category>

          <category name="Boca">
            <block type="buzzer"></block>                    
            <block type="pinmode_buzzer"></block>
            <block type="digitalwrite_buzzer"></block>
          </category>
          
          <category name="Cabeça">
            <block type="motor"></block>                  
            <block type="motor_attach"></block>
            <block type="motor_write"></block>   
          </category>

          <category name="Geral">
             <block type="serialbegin"></block>             
             <block type="delay"></block>
          </category>

      </category>

      <category name="Easy Arabeko" colour="1500ff"> <!--Arabeko -->
        <!-- <category name="Wheeled Robot" colour="ff00e0"> Arabeko -->
            
            <block type="quadrado"></block>           
            <block type="circulo"></block>      
    
        </category>
        
    <category name="Medium Arabeko" colour="ff007b"> <!--Arabeko -->
      <!-- <category name="Wheeled Robot" colour="ff00e0"> Arabeko -->
          <category name="Direções">
            <block type="software"></block>           
            <block type="namebegin"></block> 
            <block type="serialbegin"></block>          
            <block type="serialprint"></block>
            <block type="serialprintln"></block>
          </category>
  
          <category name="Funções Gerais">
            <block type="pinmode_led"></block>           
            <block type="digitalwrite_led"></block>         
            <block type="analogwrite"></block>  
            <block type="map"></block>            
            <block type="if"></block> 
          </category>
  
      </category>

      <category name="Master Arabeko" colour="ff8000"> <!--Arabeko -->
        <!-- <category name="Wheeled Robot" colour="ff00e0"> Arabeko -->
            <category name="Serial">
              <block type="software"></block>           
              <block type="namebegin"></block> 
              <block type="serialbegin"></block>          
              <block type="serialprint"></block>
              <block type="serialprintln"></block>
            </category>
    
            <category name="Funções Gerais">
              <block type="pinmode_led"></block>           
              <block type="digitalwrite_led"></block>         
              <block type="analogwrite"></block>  
              <block type="map"></block>            
              <block type="if"></block> 
            </category>
    
            <category name="Variáveis">
              <block type="byte"></block>  
              <block type="int"></block>  
              <block type="igualdade"></block>  
            </category>
    
        </category>
  
    </xml>    

    <script>
          var mostrar = "nada";
          var workspace = Blockly.inject('blocklyDiv', {
              toolbox: document.getElementById('toolbox')
          });
  
          function update(event) {
            Blockly.C.INFINITE_LOOP_TRAP = null;
              var code = new String(Blockly.C.workspaceToCode(workspace));               
              var codeElement = document.getElementById("codigogerado");
        
              if (code!= "") {   
                mostrar = code;             

                // Define a formatação como código C/C++
                codeElement.innerHTML = "<pre><code class='language-c'>" + 
                                        mostrar.replace(/</g, "&lt;").replace(/>/g, "&gt;") + 
                                        "</code></pre>";
                
                // Reaplica o realce de sintaxe
                // hljs.highlightElement(codeElement.querySelector("code"));
             
                cleanThanUp();                   
              }
          }
  
          function cleanThanUp() {
              var list = document.getElementById("im"); 
              while (list.hasChildNodes()) {
                  list.removeChild(list.childNodes[0]);
              }
              updateGraph();
          }

          function updateGraph() {
              if(mostrar != "nada"){
                var Viz = new Viz();
                viz.renderSVGElement(mostrar)
                .then(function(element){
                    document.getElementById("im").appendChild(element);
                })
                .catch(error => {
                  viz = new Viz();
                  console.error(error);
                });
              }
          }
          workspace.addChangeListener(update);     

          // document.getElementById("Download").addEventListener("click", function() {
          //       var fileName = "codigo_gerado.c";
                
          //       // Obtém o conteúdo que está visível na tela (dentro da área onde o código C está sendo exibido)
          //       var fileContent = document.getElementById("codigogerado").innerText; 
                
          //       // Cria um link temporário para download
          //       var element = document.createElement('a');
          //       element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(fileContent));
          //       element.setAttribute('download', fileName);

          //       document.body.appendChild(element);
                
          //       // Simula um clique para iniciar o download
          //       element.click();
                
          //       // Remove o elemento temporário
          //       document.body.removeChild(element);
          //   });

          let port;
          let writer;
        
          document.getElementById("connectArduino").addEventListener("click", async () => {
              try {
                  // Solicita ao usuário que selecione um dispositivo serial
                  port = await navigator.serial.requestPort();
                  await port.open({ baudRate: 115200 });
        
                  // Cria um writer para enviar dados
                  writer = port.writable.getWriter();
        
                  document.getElementById("sendCode").disabled = false;
                  alert("Conectado ao Arduino!");
        
              } catch (error) {
                  console.error("Erro ao conectar:", error);
                  alert("Falha ao conectar ao Arduino.");
              }
          });

          document.getElementById("sendCode").addEventListener("click", async () => {
              let code = document.getElementById("codigogerado").innerText;
              if (!code) {
                  alert("Nenhum código gerado!");
                  return;
              }

              // Nome do arquivo que será salvo
              let fileName = "codigo_gerado.ino";
              let fileContent = code;

              // // Criar e baixar o arquivo .ino
              // let blob = new Blob([fileContent], { type: "text/plain" });
              // let a = document.createElement("a");
              // a.href = URL.createObjectURL(blob);
              // a.download = fileName;
              // document.body.appendChild(a);
              // a.click();
              // document.body.removeChild(a);

              alert("Código salvo como .ino. Agora será enviado para o Arduino.");

              const { exec } = require("child_process");
              const fs = require("fs");
              const path = require("path");

              try {
                const fileName = "codigo_gerado.ino"; // Substitua pelo nome real do arquivo
                const fileBaseName = path.parse(fileName).name; // Nome sem extensão
                const dirPath = path.join(__dirname, fileBaseName); // Caminho da pasta

                // Criar a pasta se não existir
                if (!fs.existsSync(dirPath)) {
                    fs.mkdirSync(dirPath);
                    console.log(`Pasta criada: ${dirPath}`);
                }

                // Criar o arquivo dentro da pasta
                const filePath = path.join(dirPath, fileName);
                if (!fs.existsSync(filePath)) {
                    fs.writeFileSync(filePath, "// Código Arduino aqui\nvoid setup() {}\nvoid loop() {}");
                    console.log(`Arquivo criado: ${filePath}`);
                }
                  exec("arduino-cli board list", (error, stdout, stderr) => {
                      if (error) {
                          console.error(`Erro ao listar placas: ${error.message}`);
                          console.error(`stderr: ${stderr}`);
                          alert("Erro ao listar placas.");
                          return;
                      }

                      console.log("Saída do board list:", stdout);

                      let match = stdout.match(/(\/dev\/tty\w+|COM\d+)\s+(\S+)/);
                      if (!match) {
                          alert("Nenhuma placa encontrada!");
                          return;
                      }

                      let port = match[1]; // Porta do Arduino
                      let fqbn = match[2]; // Nome da placa

                      console.log(`Placa encontrada: ${fqbn} na porta ${port}`);

                      if (!fileName) {
                          console.error("Erro: fileName não está definido!");
                          alert("Erro: Nome do arquivo não especificado.");
                          return;
                      }             
                      if (fqbn === "Unknown") {
                          console.warn("Placa não reconhecida! Usando um modelo padrão...");
                          fqbn = "arduino:avr:uno"; // Substitua pelo modelo correto encontrado no passo 1
                      }

                      exec(`arduino-cli compile --fqbn ${fqbn} ${dirPath}`, (compErr, compStdout, compStderr) => {
                      if (compErr) {
                          console.error(`Erro ao compilar: ${compErr.message}`);
                          console.error(`stderr: ${compStderr}`);
                          alert("Erro na compilação.");
                          return;
                      }

                      console.log("Compilação:", compStdout);

                      exec(`arduino-cli upload -p ${port} --fqbn ${fqbn} ${dirPath}`, (uploadErr, uploadStdout, uploadStderr) => {
                          if (uploadErr) {
                              console.error(`Erro ao enviar código: ${uploadErr.message}`);
                              console.error(`stderr: ${uploadStderr}`);
                              alert("Falha ao enviar código.");
                              return;
                          }

                          console.log("Upload:", uploadStdout);
                          alert("Código enviado com sucesso!");
                      });
                    });
                  });
                } catch (error) {
                    console.error("Erro ao executar arduino-cli:", error);
                    alert("Erro ao executar o arduino-cli.");
                }

          });

  </script>

  <footer class="page-footer blue">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">Ereko Blockly Test</h5>
          <p class="grey-text text-lighten-4">Layout criado para Versão teste do Ereko Blockly</p>
          <!-- <p class="grey-text text-lighten-4">Test Version of Ereko Blockly</p> -->
        </div>
  
    <div class="footer-copyright">
      <div class="container">
      Made by Ana Caroline da Rocha Braz  Universidade de Brasilia 2024
      </div>
    </div>
  </footer>

    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript" src="js/materialize.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/FileSaver.js"></script>
    <script type="text/javascript" src="js/prettify.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>

  </body>
</html>