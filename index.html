<!DOCTYPE html>
<html>
 
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <meta name="description" content="Blockly for arduino">
  <meta name="keywords" content="Arduino, Blockly, Ereko, Modelos Educacionais">
  <meta name="author" content="Ana Caroline Braz">

  <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
  <link rel="manifest" href="favicon_io/site.webmanifest">

  <title>Rupyly</title>
  
  <!-- Materialize CSS -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

  <!-- Highlight.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/arduino-light.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>

    <!-- Viz.js para grafos -->
  <script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.0/viz.js"></script>
  
  <!--blocklys-->
  <script src="blockly/blockly_compressed.js"></script>
  <script src="blockly/blocks_compressed.js"></script>
  <script src="blockly/arduino_compressed.js"></script>
  <script src="blockly/msg/js/pt-br.js"></script> 
  <script src="blockly/blocos.js"></script>  
  <script src="blockly/generator.js"></script>
  <script src="blockly/workspace.js"></script>    

  <!-- jQuery e AOS -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
 
<style>
  .clearfix {
    overflow: auto;
  }

  #resizable-container {
    display: flex;
    flex-direction: row;
    height: calc(100vh - 120px); /* 100% da altura da tela menos o nav */
    min-width: 100px;
    border: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }

  #panel-blocks, #panel-code {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 150px;
    flex-grow: 1;
  }

  #panel-blocks {
    border-right: 2px solid #2c7fd2;
    background-color: #598aba;
  }

  #panel-code {
    border-left: 2px solid #22f702;
    background-color: white;
    color: black;
  }

  .header {
    text-align: center;
    padding-right: 40px;
    padding: 10px;
    font-weight: bold;
    position: relative;
  }

  .header h5 {
    margin: 0;
  }
  .header a {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #000;
    border: 1px solid black;
    padding: 3px;
    border-radius: 15px;
  }

  #panel-blocks .header {
    background-color: #2c7fd2;
    color: white;
  }

  #panel-code .header {
    background-color: #22f702;
    color: black;
  }

  #blocklyDiv {
    flex: 1;
    min-width: 0;
    border: 5px solid #2c7fd2;
    background-color: white;
    overflow: auto;
  }

  #codigogerado {
    flex: 1;
    min-width: 0;
    background-color: #fff;
    color: #000;
    border: 5px solid #22f702;
    overflow: auto;
    white-space: pre-wrap;
  }


  #dragbar {
    width: 2px;
    cursor: col-resize;
    background-color: #444;
    opacity: 0.5;
    transition: opacity 0.2s ease;
  }

  #dragbar:hover {
    opacity: 1;
  }

  /* Layout adaptável em telas pequenas */
  @media (max-width: 768px) {
    #resizable-container {
      flex-direction: column;
    }

    #panel-blocks, #panel-code {
      width: 100% !important;
      height: 50vh;
    }

    #dragbar {
      width: 100%;
      height: 5px;
      cursor: row-resize;
    }
}
</style>

</head>
<!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->

  <body>
    <nav class="light-blue lighten-1" role="navigation">
      <div class="nav-wrapper">      
          <div class="left-buttons">
            <button id="baixarPDF" class="btn waves-effect waves-light">
              Primeiras explicações
            </button>
        
            <button class="btn waves-effect waves-light" onclick="togglePanel('reset')">
              Restaurar Telas
            </button>
        </div>
        <!-- <div class="logo-container" style="display: flex; align-items: center;"> -->
          <img src="favicon_io/name.png" alt="Logo" style="height: 50px;">
        <!-- </div> -->
        <div class="nav-buttons">
          <button id="Download" class="btn waves-effect waves-light" type="submit">Download do Código (.ino)</button>
          <button id="sendCode" class="btn waves-effect waves-light">Enviar Cógigo</button>
        </div>
      </div>
    </nav>
       
    <div id="statusUpload" style="white-space: pre-wrap; display: none;"></div>


    <div id="resizable-container">
      <!-- Painel dos blocos -->
      <div id="panel-blocks">
        <div class="header">
          <h5 style="margin: 0;">Área destinada aos blocos</h5>         
            <a href="#" class="right hide-on-small-only" onclick="togglePanel('panel-blocks')">
              <i class="material-icons">close</i>
            </a>          
        </div>
        <div id="blocklyDiv" class="clearfix"></div>
      </div>
  
      <!-- Barra de drag -->
      <div id="dragbar"></div>
  
      <!-- Painel do código -->
      <div id="panel-code">
        <div class="header">
          <h5 style="margin: 0;">Área destinada à geração do código em C</h5>
          <a href="#" class="right hide-on-small-only" onclick="togglePanel('panel-code')">
            <i class="material-icons">close</i>
          </a>
        </div>
        <div id="codigogerado"></div>
      </div>
    </div>

    <xml id="toolbox" style="display: none">	 
        
      <category name="Biblioteca" colour="2eff00">
        <block type="Biblioteca_Motor"></block>
        <block type="SoftwareSerial"></block>         
      </category>

      <category name="Funções" colour="d6df1c">
          <block type="setup"></block>
          <block type="loop"></block>
          <block type= funcao></block>
          <block type="chamada"></block>
          <block type="if"></block> 
          <block type="else"></block>
      </category> 

      <category name="Erekopapa" colour="00ffaa"> <!-- Antropomórfico -->
      <!-- <category name="Anthropomorphic" colour="00ffaa"> Erekopapa      -->
          <category name="Olhos" >
              <block type="led"></block>              
              <block type="pinmode_led"></block>              
              <block type="digitalwrite_led"></block>
          </category>

          <category name="Boca">
            <block type="buzzer"></block>                    
            <block type="pinmode_buzzer"></block>
            <block type="digitalwrite_buzzer"></block>
          </category>
          
          <category name="Cabeça">
            <block type="motor"></block>                  
            <block type="motor_attach"></block>
            <block type="motor_write"></block>   
          </category>

          <category name="Geral">
             <block type="serialbegin"></block>             
             <block type="delay"></block>
             <!-- <block type="chamada"></block> -->
             <block type="texto"></block>
          </category>

      </category>
      
      <category name="Arabeko" colour="1500ff"> <!--Arabeko -->
        <category name="Arabeko Autônomo" colour="1500ff"> <!--Arabeko -->
          <!-- <category name="Wheeled Robot" colour="ff00e0"> Arabeko -->
              
              <block type="quadrado"></block>           
              <block type="circulo"></block>      
              <!-- <block type="triangulo"></block> -->
              <block type="reto"></block>
              <!-- <block type="atras"></block> -->
        </category>
          
      <!-- <category name="Medium Arabeko" colour="ff007b"> Arabeko -->
        <!-- <category name="Wheeled Robot" colour="ff00e0"> Arabeko -->
            <!-- <category name="Direções"> 
              <block type="Direita"></block>           
              <block type="Esquerda"></block> 
              <block type="Frente"></block>          
              <block type="Tras"></block>
              <block type="Parar"></block>
            </category>
    
            <category name="Funções Gerais">
            </category>
     -->
        <!-- </category> -->

        <category name="Arabeko Original" colour="ff8000"> <!--Arabeko -->
          <!-- <category name="Wheeled Robot" colour="ff00e0"> Arabeko -->
            <category name="Geral">
              <block type="pinmode"></block>           
              <block type="digitalwrite"></block>         
              <block type="analogwrite"></block>  
              <!-- <block type="map"></block>             -->
              <!-- <block type="chamada"></block> -->
              <block type="texto"></block>
              <block type="delay"></block>
            </category>
      
            <category name="Serial">
                <block type="software"></block>           
                <block type="namebegin"></block> 
                <block type="serialbegin"></block>          
                <block type="serialprint"></block>
                <block type="serialprintln"></block>
              </category>

              
              <category name="Motores">
                <block type="motor"></block>                  
                <block type="motor_attach"></block>
                <block type="motor_write"></block>    
              </category>
      

              <category name="Variáveis">
                <block type="byte"></block>  
                <block type="int"></block>  
                <!-- <block type="igualdade"></block>  -->
                <block type="atribuicao"></block> 
              </category>    
        </category>
  
    </xml>    

    <script>
    // Criação do workspace Blockly e conexão com o toolbox

      var workspace = Blockly.inject('blocklyDiv', {
          toolbox: document.getElementById('toolbox'),
          scrollbars: true,
          zoom: {
              controls: true,
              wheel: true,
              startScale: 1.0,
              maxScale: 3,
              minScale: 0.3,
              scaleSpeed: 1.2
          },
          move: {
              scrollbars: true,
              drag: true,
              wheel: true
          },
          sounds: true,
          grid: {
            spacing: 100,
            length: 5,
            colour: '#999',
            snap: false
          },
          collapse: true,
          comments: true,
          disable: false,
          maxBlocks: Infinity,
          trashcan: true,
          horizontalLayout: false,
          toolboxPosition: 'start',
          css: true,
        });
        
      var mostrar = "nada";  

      // Função chamada sempre que houver mudança no workspace (blocos)
      function update(event) {
          var code = Blockly.Arduino.workspaceToCode(workspace);               
          var codeElement = document.getElementById("codigogerado");

          // Se o código gerado estiver vazio, limpa a área de código
          if (code.trim() === "") {
              codeElement.innerHTML = "<pre><code class='language-c'></code></pre>";
          } else {
              // Caso contrário, exibe o código gerado
              codeElement.innerHTML = "<pre><code class='language-c'>" + 
                                              code.replace(/</g, "&lt;").replace(/>/g, "&gt;") + 
                                              "</code></pre>";
              hljs.highlightElement(codeElement.querySelector("code"));
          }
      }

      workspace.addChangeListener(update);
      //-------------------------------------------------------------------------------------------------
      // Drag resize
    const dragbar = document.getElementById('dragbar');
    const panelBlocks = document.getElementById('panel-blocks');
    const panelCode = document.getElementById('panel-code');
    const container = document.getElementById('resizable-container');

    dragbar.addEventListener('mousedown', (e) => {
      e.preventDefault();

      document.body.style.userSelect = 'none';
      dragbar.style.opacity = '1';

      function onMouseMove(e) {
        const containerRect = container.getBoundingClientRect();
        let newWidthBlocks = e.clientX - containerRect.left;

        const minWidth = 150;
        const maxWidth = containerRect.width - minWidth - dragbar.offsetWidth;

        if (newWidthBlocks < minWidth) newWidthBlocks = minWidth;
        if (newWidthBlocks > maxWidth) newWidthBlocks = maxWidth;

        panelBlocks.style.flexGrow = '0';
        panelBlocks.style.width = newWidthBlocks + 'px';

        panelCode.style.flexGrow = '0';
        panelCode.style.width = (containerRect.width - newWidthBlocks - dragbar.offsetWidth) + 'px';

        // Ajusta Blockly para o novo tamanho
        // Redimensiona o workspace do Blockly
        Blockly.svgResize(workspace);


      }

      function onMouseUp() {
        document.body.style.userSelect = 'auto';
        dragbar.style.opacity = '0.5';
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);

        // Restaura o layout metade-metade
        panelBlocks.style.flexGrow = '1';
        panelBlocks.style.width = '50%';

        panelCode.style.flexGrow = '1';
        panelCode.style.width = '50%';

        Blockly.svgResize(workspace); // Redimensiona o Blockly após restaurar
      }


      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);

    });


      // -------------------------------------------------------------------------------------------------

      document.getElementById("Download").addEventListener("click", function () {
          // Pergunta ao usuário o nome do arquivo
          var fileName = prompt("Digite o nome do arquivo:", "codigo_arduino");

          // Se o usuário cancelar ou deixar em branco, interrompe
          if (!fileName) return;

          // Garante que o nome termina com .ino
          if (!fileName.endsWith(".ino")) {
              fileName += ".ino";
          }

          // Pega o conteúdo exibido no campo de código
          var fileContent = document.getElementById("codigogerado").innerText;

          // Cria um link temporário para download
          var element = document.createElement("a");
          element.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(fileContent));
          element.setAttribute("download", fileName);

          document.body.appendChild(element);

          // Simula o clique para iniciar o download
          element.click();

          // Remove o link da página
          document.body.removeChild(element);
      });

document.getElementById("sendCode").addEventListener("click", async () => {
  const code = document.getElementById("codigogerado").innerText;
  const statusEl = document.getElementById("statusUpload");

  if (!code) {
    alert("Nenhum código gerado!");
    return;
  }

  function mostrarStatus(texto, cor) {
    if (cor === "red") {
      // Aqui assumimos que texto já tem múltiplas linhas
      texto = texto
        .split('\n')
        .map(linha => {
          // Remove caminho absoluto, mantém só "sketch.ino:linha:coluna: mensagem"
          return linha.replace(/.*\.ino:\d+:\d+:\s*/, '');
        })
        .filter(linha => linha.trim() !== '') // remove linhas vazias
        .join('\n'); // manter as quebras de linha

      // Substitui 'error:' para visual mais limpo
      texto = texto.replace(/error:/g, '❌ Erro:');
    }

    statusEl.textContent = texto;
    statusEl.style.backgroundColor = cor === "green" ? "#4caf50" : "#e53935";
    statusEl.style.color = "white";
    statusEl.style.padding = "10px";
    statusEl.style.marginTop = "10px";
    statusEl.style.borderRadius = "5px";
    statusEl.style.display = "block";
    //statusEl.style.whiteSpace = "pre-wrap";

    if (cor === "green") {
      setTimeout(() => {
        statusEl.style.display = "none";
      }, 25000);
    } 
    else if (cor === "red") {
      setTimeout(() => {
        statusEl.style.display = "none";
      }, 50000);
    } 
  }

  try {
    const response = await fetch("https://ereko-blockly-back.onrender.com/salvar-codigo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code }),
    });

    const text = await response.text();

    if (!response.ok) {
      mostrarStatus("❌ Falha ao salvar código:\n" + text, "red");
      return;
    }

    mostrarStatus("⏳ Código salvo no servidor, aguardando upload...", "green");
    const momentoEnvio = Date.now();

    // Função para consultar status do upload
    async function consultarStatusUpload(maxTentativas = 20, intervaloMs = 500) {
      for (let i = 0; i < maxTentativas; i++) {
        try {
          const statusResp = await fetch("https://ereko-blockly-back.onrender.com/status-upload");
          const statusJson = await statusResp.json();

          if (statusJson.timestamp && new Date(statusJson.timestamp).getTime() >= momentoEnvio) {
            console.log("📥 Status recebido do servidor:", statusJson);
            mostrarStatus(statusJson.mensagem, statusJson.sucesso ? "green" : "red");
            return;
          }
        } catch (err) {
          // Ignora erro e tenta novamente
        }

        await new Promise((r) => setTimeout(r, intervaloMs));
      }
      mostrarStatus("❌ Tempo esgotado para obter status do upload.", "red");
    }

    consultarStatusUpload();

  } catch (err) {
    mostrarStatus("❌ Erro de rede ou servidor: " + err.message, "red");
  }
});


    window.addEventListener('resize', () => Blockly.svgResize(workspace));
    window.addEventListener('load', () => Blockly.svgResize(workspace));

    function togglePanel(panelId) {
      const panelBlocks = document.getElementById('panel-blocks');
      const panelCode = document.getElementById('panel-code');
      const dragbar = document.getElementById('dragbar');

      if (panelId === 'reset') {
        panelBlocks.style.display = 'flex';
        panelCode.style.display = 'flex';
        panelBlocks.style.flexGrow = '1';
        panelCode.style.flexGrow = '1';
        dragbar.style.display = 'block';
        Blockly.svgResize(workspace);
        return;
      }

      const panel = document.getElementById(panelId);
      const otherPanel = panelId === 'panel-blocks' ? panelCode : panelBlocks;

      if (panel.style.display === 'none') {
        panel.style.display = 'flex';
        otherPanel.style.display = 'flex';
        dragbar.style.display = 'block';
      } else {
        panel.style.display = 'none';
        otherPanel.style.flexGrow = '1';
        otherPanel.style.width = '100%';
        dragbar.style.display = 'none';
      }

      Blockly.svgResize(workspace);
    }

    document.getElementById('baixarPDF').addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = 'assets/Rupyly_Primeiros_Passos.pdf'; // Caminho do arquivo
        link.download = 'Rupyly_Primeiros_Passos.pdf';    // Nome do arquivo
        link.style.display = 'none';                      // Esconde o link
        document.body.appendChild(link);                  // Adiciona ao DOM
        link.click();                                     // Simula clique
        document.body.removeChild(link);                  // Remove depois
     });

  </script>

  <footer class="page-footer">
    <h5 class="page-footer-h5">Rupyly</h5>
    <p class="page-footer-p">Software exclusivo para modelos educacionais do grupo de pesquisa Ereko</p>
    <p class="footer-copyright">Made by Ana Caroline da Rocha Braz — Universidade de Brasília © 2024.  Todos os direitos reservados.</p>
  </footer>


    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript" src="js/materialize.min.js"></script>
  </body>
</html>